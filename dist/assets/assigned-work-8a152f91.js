import{d as R,C as g,O as H,P as Q,c as u,r as v,Q as j,E as q}from"./index-d17ade26.js";import{i as z}from"./deltaHelpers-643e5dae.js";const K=R("assigned-works-module:assigned-work",()=>{const c=g.Services.AssignedWork,t=g.Services.UI,m=H(),k=Q(),l=u(()=>m.params.mode),p=v(!1),y=v(""),x=j({visible:!1,onlyFalse:!1}),S=v(!1),f=u(()=>m.params.workId),e=v(null);async function L(){var s,a,r;t.setLoading(!0);try{const n=await c.getAssignedWork(f.value);if(e.value=n.data,l.value==="solve"&&["made-in-deadline","made-after-deadline"].includes(((s=e.value)==null?void 0:s.solveStatus)||""))throw new Error("Работа уже сдана и не может быть изменена");if(l.value==="check"&&["not-started","in-progress"].includes(((a=e.value)==null?void 0:a.solveStatus)||""))throw new Error("Работа еще не сдана и не может быть проверена");if(l.value==="check"&&["checked-in-deadline","checked-after-deadline"].includes(((r=e.value)==null?void 0:r.checkStatus)||""))throw new Error("Работа уже проверена и не может быть изменена")}catch(n){t.openErrorModal("Ошибка",(n==null?void 0:n.status)===404?"Работа не найдена. Возможно, работа была удалена и остался только этот экземпляр":n.message),e.value=null}finally{t.setLoading(!1)}}const b=u(()=>`/assigned-works/${f.value}/${l.value}`),d=u(()=>m.params.taskSlug),h=v(),w=v();q([d,f,l],()=>{if(!e.value||!d.value){w.value=null,h.value=null;return}const s=U(d.value);if(!s){w.value=null,h.value=null;return}h.value=s.id,w.value=s},{immediate:!0});const o=u(()=>{if(!e.value)return null;const s=g.Context.User.role;return s==="student"&&l.value==="read"?e.value.score||0:s==="mentor"&&l.value==="check"?e.value.comments.reduce((a,r)=>a+(r.score||0),0):e.value.checkStatus==="checked-in-deadline"||e.value.checkStatus==="checked-after-deadline"?e.value.score||0:null}),A=u(()=>{if(o.value===null)return null;if(o.value===0)return"0 баллов";const s=o.value%10;return o.value>10&&o.value<20?`${o.value} баллов`:s===1?`${o.value} балл`:s>1&&s<5?`${o.value} балла`:`${o.value} баллов`}),T=u(()=>{var r;const s=e.value.work.tasks.findIndex(n=>n.slug===d.value);if(s===e.value.work.tasks.length-1)return"";const a=(r=e.value.work.tasks[s+1])==null?void 0:r.slug;return b.value+"/"+a}),$=u(()=>{var r;const s=e.value.work.tasks.findIndex(n=>n.slug===d.value);if(s===0)return"";const a=(r=e.value.work.tasks[s-1])==null?void 0:r.slug;return b.value+"/"+a}),C=u(()=>{const s=g.Context.User.role;let a="hidden",r="hidden",n="hidden";switch(s){case"student":a=l.value==="solve"?"visible":"readonly",r=l.value==="solve"?"hidden":"readonly",n=l.value==="solve"?"hidden":"readonly";break;case"mentor":a="readonly",r=l.value==="check"?"visible":"readonly",n=l.value==="check"?"visible":"readonly";break;case"admin":case"teacher":a="readonly",r="readonly",n="readonly";break}return{solveBox:a,checkBox:r,scoreBox:n}});function D(s){var a,r;return(r=(a=e.value)==null?void 0:a.work)==null?void 0:r.tasks.find(n=>n.id===s)}function U(s){var a,r;return(r=(a=e.value)==null?void 0:a.work)==null?void 0:r.tasks.find(n=>n.slug===s)}function M(s){var r;if(l.value==="read"||!e.value||!((r=e.value)!=null&&r.answers))return!1;const a=e.value.answers.find(n=>n.taskId===s.id);if(!a)return!1;switch(s.type){case"one_choice":case"multiple_choice":return!!(a.chosenTaskOptionIds&&a.chosenTaskOptionIds.length>0);case"word":return!!(a.word&&a.word.trim().length>0);case"text":return!z(a.content)}}function _(s){var r,n,i,W,E,I;if(l.value==="solve"||((r=e.value)==null?void 0:r.solveStatus)==="not-started"||((n=e.value)==null?void 0:n.solveStatus)==="in-progress")return null;const a=(i=e.value)==null?void 0:i.comments.find(F=>F.taskId===s.id);return a?(((W=e.value)==null?void 0:W.checkStatus)==="not-checked"||((E=e.value)==null?void 0:E.checkStatus)==="in-progress")&&((I=g.Context.User)==null?void 0:I.role)!=="mentor"?null:a.score===0?"error":a.score===s.highestScore?"success":"warning":s.type!=="text"?"error":null}async function B(){var r,n;if(!e.value)return;const s=((r=e.value.work)==null?void 0:r.tasks)||[];if(l.value==="solve"&&!s.every(i=>M(i))?y.value="Вы не ответили на все вопросы":y.value="",!p.value){p.value=!0;return}t.setLoading(!0);const a=[{label:"Вернуться к списку работ",design:"secondary",handler:()=>{k.push("/assigned-works")}}];(n=e.value.work)!=null&&n.tasks.every(i=>i.type!=="text")&&a.unshift({label:"Посмотреть результат",design:"primary",handler:()=>{window.location.href=`/assigned-works/${f.value}/read`}});try{l.value==="solve"?(await c.solveAssignedWork(e.value.id,{answers:e.value.answers}),t.openSuccessModal("Работа успешно сдана!","",a)):l.value==="check"&&(await c.checkAssignedWork(e.value.id,{answers:e.value.answers,comments:e.value.comments}),t.openSuccessModal("Работа успешно проверена!","Если работа без открытых вопросов, она будет проверена автоматически и Вы можете просмотреть результат сразу. В случае работ с хотя б одним открытым вопросом требуется проверка куратора",[{label:"Вернуться к списку работ",design:"primary",handler:()=>{k.push("/assigned-works")}}]))}catch(i){t.openErrorModal("Ошибка при отправке работы",i.message)}finally{t.setLoading(!1)}}async function O(){if(!(l.value==="read"||!e.value)){if(!S.value){S.value=!0;return}t.setLoading(!0);try{await c.shiftAssignedWorkDeadline(e.value.id),t.openSuccessModal("Дедлайн успешно сдвинут!")}catch(s){t.openErrorModal("Ошибка при сдвиге дедлайна",s.message)}finally{t.setLoading(!1)}}}async function P(){if(!e.value)return;t.setLoading(!0);const s={...e.value,work:void 0};try{await c.saveAssignedWorkProgress(e.value.id,s),t.openSuccessModal("Прогресс успешно сохранен!","",[{label:"Вернуться к списку работ",design:"primary",handler:()=>{k.push("/assigned-works")}}])}catch(a){t.openErrorModal("Ошибка при сохранении прогресса",a.message)}finally{t.setLoading(!1)}}async function V(){var s;if(e.value){if(((s=e.value.work)==null?void 0:s.type)!=="test"){t.openErrorModal("Ошибка при создании нового экземпляра работы","Можно пересдавать только тестовую работу. Эта работа содержит открытые вопросы");return}t.setLoading(!0);try{await c.remakeAssignedWork(e.value.id,x.onlyFalse),t.openSuccessModal("Работа успешно создана и появилась в списке!","Если работы нет в списке, попробуйте обновить страницу",[{label:"Вернуться к списку работ",design:"primary",handler:()=>{k.push("/assigned-works")}}])}catch(a){t.openErrorModal("Ошибка при создании нового экземпляра работы",a.message)}finally{t.setLoading(!1)}}}return{assignedWorkId:f,assignedWork:e,taskSlug:d,taskId:h,task:w,sureSubmitModalVisible:p,sureSubmitModalError:y,shiftDeadlineModalVisible:S,shiftDeadline:O,getTask:D,taskHasAnswer:M,taskScoreStatus:_,submitWork:B,mode:l,fieldVisibility:C,baseUrl:b,nextTaskLink:T,previousTaskLink:$,fetchAssignedWork:L,workScoreText:A,workScore:o,saveProgress:P,remakeWork:V,remakeModal:x,_router:k}});export{K as u};
