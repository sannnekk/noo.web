import{x as U,d as k,Z as ne,r as T,o as oe,a as g,j as y,u as v,f as L,$ as D,w as q,b as M,e as b,y as V,C as S,E as K,_ as I,g as d,k as m,a0 as R,v as j,t as ie,c as $,q as J,s as P,P as Z,T as se,a1 as H,a2 as le,p as Q,l as W,O as ae,a3 as ce,a4 as re,a5 as de,G as ue,a6 as _e,a7 as pe,a8 as ge}from"./index-021de7be.js";import{S as A}from"./settings-section-b49d31bc.js";var B={library:"https://accounts.google.com/gsi/client",defaultButtonConfig:{theme:"outline",size:"large"},scopes:"email profile openid",ssrError:"vue3-google-login cannot be executed on the server side. See here for more info https://devbaji.github.io/vue3-google-login/#no-ssr-support"};const w=U({clientId:null,popupType:"CODE",prompt:!1,autoLogin:!1,idConfiguration:null,buttonConfig:B.defaultButtonConfig,callback:()=>{},error:null}),E=U({apiLoaded:!1,apiLoadIntitited:!1}),ve=()=>new Promise((e,t)=>{if(typeof window<"u"){if(!E.apiLoadIntitited){const i=document.createElement("script");E.apiLoadIntitited=!0,i.addEventListener("load",()=>{E.apiLoaded=!0,e(window.google)}),i.addEventListener("error",()=>{t("Failed to load the Google 3P Authorization JavaScript Library.")}),i.src=B.library,i.async=!0,i.defer=!0,document.head.appendChild(i)}}else t(B.ssrError)}),x=e=>{E.apiLoadIntitited?E.apiLoaded?e(window.google):q(()=>E.apiLoaded,t=>{t&&e(window.google)}):ve().then(t=>{e(t)})},me=(e,t,i,o)=>{if(!e.client_id)throw new Error("Prop client id required since plugin is not initialized with a client id");x(()=>{((n,c,l,u,s)=>{if(s){const _=n.callback;n.callback=r=>{r.credential?_&&_(r):s(r)}}window.google.accounts.id.initialize(n);const a=c.value;a&&!u&&window.google.accounts.id.renderButton(a,l)})(e,t,i.buttonConfig,o,i.error),i.prompt&&fe({clientId:i.clientId,callback:i.callback,error:i.error,autoLogin:i.autoLogin})})},ye=e=>new Promise((t,i)=>{x(o=>{if(!(e&&e.clientId||w.clientId))throw new Error("clientId is required since the plugin is not initialized with a Client Id");o.accounts.oauth2.initCodeClient({client_id:e&&e.clientId||w.clientId||"",scope:B.scopes,ux_mode:"popup",callback:n=>{n.code?t(n):i(n)},error_callback:n=>{i(n)}}).requestCode()})}),he=e=>new Promise((t,i)=>{x(o=>{if(!(e&&e.clientId||w.clientId))throw new Error("clientId is required since the plugin is not initialized with a Client Id");o.accounts.oauth2.initTokenClient({client_id:e&&e.clientId||w.clientId||"",scope:B.scopes,callback:n=>{n.access_token?t(n):i(n)},error_callback:n=>{i(n)}}).requestAccessToken()})}),fe=e=>{if(!e&&(e={}),!e.clientId&&!w.clientId)throw new Error("clientId is required");const t={use_fedcm_for_prompt:!0};return e.clientId&&(t.client_id=e.clientId),!e.clientId&&w.clientId&&(t.client_id=w.clientId),e.context&&(t.context=e.context),e.autoLogin!=null&&(t.auto_select=e.autoLogin),e.cancelOnTapOutside!=null&&(t.cancel_on_tap_outside=e.cancelOnTapOutside),new Promise((i,o)=>{t.callback=n=>{e&&e.callback&&e.callback(n),n.credential?i(n):o(n)},x(n=>{n.accounts.id.initialize(t),n.accounts.id.prompt()})})};var F=k({__name:"GoogleLogin",props:{clientId:{type:String,required:!1},prompt:{type:Boolean,required:!1,default:!1},autoLogin:{type:Boolean,required:!1,default:!1},popupType:{type:String,required:!1},idConfiguration:{type:Object,required:!1},buttonConfig:{type:Object,required:!1},callback:{type:Function,required:!1},error:{type:Function,required:!1}},setup(e){if(!(typeof window<"u"))throw new Error(B.ssrError);const t=!!ne().default,i=e,o=((l,u)=>{const s={...l};for(const a in u)u[a]!==void 0&&u[a]!==null&&(s[a]=u[a]);return s})(w,i),n={client_id:o.clientId||null,auto_select:o.autoLogin||!1,callback:o.callback,...o.idConfiguration},c=T();return oe(()=>{me(n,c,o,t),i.popupType&&!t&&console.warn("Option 'popupType' is ignored since a slot which act as a custom login button was not found!!!")}),(l,u)=>(g(),y("div",{class:"g-btn-wrapper",onClick:u[0]||(u[0]=s=>v(t)&&void(v(o).popupType==="TOKEN"?he({clientId:o.clientId}).then(a=>{o.callback&&o.callback(a)}).catch(a=>{o.error&&o.error(a)}):ye({clientId:o.clientId}).then(a=>{o.callback&&o.callback(a)}).catch(a=>{o.error&&o.error(a)})))},[v(t)?L("v-if",!0):(g(),y("span",{key:0,ref_key:"buttonRef",ref:c,class:"g-btn"},null,512)),D(l.$slots,"default")]))}});(function(e,t){t===void 0&&(t={});var i=t.insertAt;if(e&&typeof document<"u"){var o=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",i==="top"&&o.firstChild?o.insertBefore(n,o.firstChild):o.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}})(`
.g-btn-wrapper[data-v-5e610566] {
  display: inline-block;
}
`),F.__scopeId="data-v-5e610566",F.__file="src/plugin/GoogleLogin.vue";const be=k({__name:"google-auth-button",props:{design:{}},emits:["login"],setup(e,{emit:t}){const i=t;function o(c){i("login",c)}function n(){x(c=>{c.accounts.oauth2.initCodeClient({client_id:S.Constants.GOOGLE_CLIENT_ID,scope:"email profile openid https://www.googleapis.com/auth/drive.file",callback:o}).requestCode()})}return(c,l)=>{const u=K;return g(),M(u,{onClick:l[0]||(l[0]=s=>n()),design:c.design||"secondary"},{default:b(()=>[V(" Войти через Google ")]),_:1},8,["design"])}}});const we=I(be,[["__scopeId","data-v-73a1e8e1"]]);const Se={},ke={class:"success-block"},Ie={class:"success-block__icon"},Ce={class:"success-block__text"};function $e(e,t){const i=R;return g(),y("div",ke,[d("div",Ie,[m(i,{name:"check-green"})]),d("div",Ce,[D(e.$slots,"default",{},void 0,!0)])])}const Ee=I(Se,[["render",$e],["__scopeId","data-v-471b0d9c"]]),Be={key:0,class:"entity-selection-card__selected-badge"},Le={class:"entity-selection-card__icon"},Ve={class:"entity-selection-card__name"},xe=k({__name:"entity-selection-card",props:{entity:{},selected:{type:Boolean}},setup(e){const t=T(!1);return(i,o)=>{const n=R;return g(),y("div",{class:ie(["entity-selection-card",{"entity-selection-card--selected":i.selected}]),onMouseenter:o[0]||(o[0]=c=>t.value=!0),onMouseleave:o[1]||(o[1]=c=>t.value=!1)},[i.selected?(g(),y("div",Be)):L("",!0),d("div",Le,[m(n,{name:i.entity.icon,animation:t.value},null,8,["name","animation"])]),d("div",Ve,[d("p",null,j(i.entity.name),1)])],34)}}});const Ne=I(xe,[["__scopeId","data-v-f52f5195"]]);async function Oe(e){try{return await S.Services.Course.getCourses(e)}catch(t){S.Services.UI.openErrorModal("Ошибка при загрузке учеников курса",t.message)}}async function Te(e){const t=[{label:"Администратор",role:"admin",id:"1"},{label:"Ученик",role:"student",id:"2"},{label:"Учитель",role:"teacher",id:"3"},{label:"Куратор",role:"mentor",id:"4"}];if(e!=null&&e.search){const i=t.filter(o=>o.label.toLowerCase().includes(e.search.toLowerCase()));return{data:i,meta:{total:i.length,relations:[]}}}return{data:t,meta:{total:t.length,relations:[]}}}async function Me(e){try{return await S.Services.Poll.getPolls(e)}catch(t){S.Services.UI.openErrorModal("Ошибка при загрузке опросов",t.message)}}const z=[{name:"Результаты опросов",technicalName:"poll_answer",icon:"poll",availableSelectorProps:[{label:"По опросу",value:"pollId",labelKeys:["title"],fetchFunction:Me,toPropValue:e=>e.id}]},{name:"Пользователи",technicalName:"user",icon:"users",availableSelectorProps:[{label:"По роли",value:"role",labelKeys:["label"],fetchFunction:Te,toPropValue:e=>e.role},{label:"По курсу",value:"courseId",labelKeys:["name"],fetchFunction:Oe,toPropValue:e=>e.id}]}],X=e=>(Q("data-v-e90ad7d7"),e=e(),W(),e),qe={class:"entity-selection-view"},Pe=X(()=>d("h4",{class:"entity-selection-view__header"},"Выберите модуль",-1)),Ue={class:"entity-selection-view__entity-list"},Ge={key:0,class:"entity-selection-view__header"},Ae=X(()=>d("h4",null,"Выберите селектор",-1)),Fe={class:"row"},ze={class:"col-md-6"},De={class:"entity-selection-view__selector"},Ke={class:"col-md-6"},Re=k({__name:"entity-selection-view",props:{entityName:{},entitySelector:{}},emits:["update:entityName","update:entitySelector"],setup(e,{emit:t}){const i=e,o=t,n=$(()=>z.find(_=>_.technicalName===i.entityName)),c=$(()=>{var _;return(_=n.value)==null?void 0:_.availableSelectorProps.find(r=>r.value===i.entitySelector.prop)}),l=$({get:()=>i.entityName,set:_=>o("update:entityName",_)}),u=$({get:()=>i.entitySelector,set:_=>o("update:entitySelector",_)}),s=T([]);q(s,()=>{var r,p;const _=(r=s.value)==null?void 0:r.at(0);u.value={prop:u.value.prop,value:_?(p=c.value)==null?void 0:p.toPropValue(_):""}}),q(c,()=>{s.value=[]});function a(_){l.value=_.technicalName}return(_,r)=>{var O;const p=H,C=le,N=J("auto-animate");return P((g(),y("div",qe,[d("section",null,[Pe,d("div",Ue,[(g(!0),y(Z,null,se(v(z),f=>(g(),M(Ne,{key:f.technicalName,entity:f,selected:f.technicalName===l.value,onClick:G=>a(f)},null,8,["entity","selected","onClick"]))),128))])]),n.value?(g(),y("section",Ge,[Ae,P((g(),y("div",Fe,[d("div",ze,[d("div",De,[m(p,{label:"Селектор",modelValue:u.value.prop,"onUpdate:modelValue":r[0]||(r[0]=f=>u.value.prop=f),options:(O=n.value)==null?void 0:O.availableSelectorProps},null,8,["modelValue","options"])])]),d("div",Ke,[c.value?(g(),y("div",{class:"entity-selection-view__selector",key:c.value.value},[m(C,{label:"Значение (только одно)",modelValue:s.value,"onUpdate:modelValue":r[1]||(r[1]=f=>s.value=f),"label-keys":c.value.labelKeys,"fetch-function":c.value.fetchFunction,"max-count":1},null,8,["modelValue","label-keys","fetch-function"])])):L("",!0)])])),[[N]])])):L("",!0)])),[[N]])}}});const je=I(Re,[["__scopeId","data-v-e90ad7d7"]]),Y=e=>(Q("data-v-8bb2d2e3"),e=e(),W(),e),Je={class:"create-binding-view"},Ze={class:"create-binding-view__form"},He={class:"row"},Qe={class:"col-md-6"},We={class:"create-binding-view__form-field"},Xe={class:"col-md-6"},Ye={class:"create-binding-view__form-field"},et={class:"row"},tt={class:"col-md-12"},nt={class:"create-binding-view__form-field"},ot={class:"row"},it={class:"col-md-6"},st=Y(()=>d("h4",null,"Google-Аккаунт",-1)),lt={key:1,class:"create-binding-view__google-auth-button"},at={class:"col-md-6"},ct=Y(()=>d("h4",null,"Статус",-1)),rt={class:"create-binding-view__buttons"},dt=k({__name:"create-binding-view",emits:["create-integration"],setup(e,{emit:t}){const i=t,o=S.Services.UI,n=T(c());function c(){return{name:"",entityName:"",entitySelector:{prop:"",value:""},status:"active",lastErrorText:null,frequency:"daily",filePath:[],googleOAuthToken:"",googleCredentials:null,lastRunAt:null}}function l(r){n.value.googleOAuthToken=r.code,n.value.googleCredentials=r}function u(){try{s(n.value)}catch(r){o.openErrorModal("Не удлоась создать интеграцию",r.message)}i("create-integration",n.value),n.value=c()}function s(r){var p,C;if(!r)throw new Error("Форма не заполнена");if(!r.name)throw new Error("Название не заполнено");if(!r.entityName)throw new Error("Выберите модуль для привязки");if(!r.entitySelector||!((p=r.entitySelector)!=null&&p.prop)||!((C=r.entitySelector)!=null&&C.value))throw new Error("Свойство селектора сущности не заполнено");if(!r.googleOAuthToken||!r.googleCredentials)throw new Error("Перед отправкой необходимо авторизоваться через Google")}const a=[{value:"hourly",label:"Ежечасно"},{value:"daily",label:"Ежедневно"},{value:"weekly",label:"Еженедельно"},{value:"monthly",label:"Ежемесячно"}],_=$({get:()=>n.value.status==="active",set:r=>n.value.status=r?"active":"inactive"});return(r,p)=>{const C=ae,N=H,O=Ee,f=we,G=ce,ee=K,te=J("auto-animate");return g(),y("div",Je,[d("div",Ze,[d("div",He,[d("div",Qe,[d("div",We,[m(C,{modelValue:n.value.name,"onUpdate:modelValue":p[0]||(p[0]=h=>n.value.name=h),label:"Название интеграции",type:"text"},null,8,["modelValue"])])]),d("div",Xe,[d("div",Ye,[m(N,{modelValue:n.value.frequency,"onUpdate:modelValue":p[1]||(p[1]=h=>n.value.frequency=h),label:"Частота обновления",options:a},null,8,["modelValue"])])])]),d("div",et,[d("div",tt,[d("div",nt,[m(je,{"entity-name":n.value.entityName,"onUpdate:entityName":p[2]||(p[2]=h=>n.value.entityName=h),"entity-selector":n.value.entitySelector,"onUpdate:entitySelector":p[3]||(p[3]=h=>n.value.entitySelector=h)},null,8,["entity-name","entity-selector"])])])]),d("div",ot,[P((g(),y("div",it,[st,n.value.googleOAuthToken?(g(),M(O,{key:0},{default:b(()=>[V(" Вы успешно авторизовались в Google ")]),_:1})):(g(),y("div",lt,[m(f,{onLogin:p[4]||(p[4]=h=>l(h))})]))])),[[te]]),d("div",at,[ct,m(G,{modelValue:_.value,"onUpdate:modelValue":p[5]||(p[5]=h=>_.value=h),label:"Активировать интеграцию"},null,8,["modelValue"])])]),d("div",rt,[m(ee,{alignment:"right",onClick:p[6]||(p[6]=h=>u())},{default:b(()=>[V(" Создать интеграцию ")]),_:1})])])])}}});const ut=I(dt,[["__scopeId","data-v-8bb2d2e3"]]),_t=k({__name:"last-binding-error-modal",props:{visible:{type:Boolean},bindingName:{},error:{}},emits:["update:visible"],setup(e,{emit:t}){const i=e,o=t,n=$({get:()=>i.visible,set:c=>o("update:visible",c)});return(c,l)=>{const u=re;return g(),M(u,{type:"warning",title:`Ошибка интеграции ${c.bindingName}`,visible:n.value,"onUpdate:visible":l[0]||(l[0]=s=>n.value=s)},{default:b(()=>[d("p",null,j(i.error),1)]),_:1},8,["title","visible"])}}}),pt=k({__name:"bindings-table",props:{isLoading:{type:Boolean},results:{}},emits:["delete","trigger","switch-on-off"],setup(e,{emit:t}){const i=t,o=[{title:"",type:"icon",value:s=>c(s.entityName)},{title:"Название",type:"text",value:s=>s.name},{title:"Тип",type:"text",value:s=>s.entityName},{title:"Последний запуск",type:"date",value:s=>s.lastRunAt},{title:"Статус",type:"text",value:s=>{switch(s.status){case"active":return'<span style="color: var(--success)">Активна</span>';case"inactive":return'<span style="color: var(--text-light)">Неактивна</span>';case"error":return'<span style="color: var(--danger)">Ошибка</span>';default:return`<span style="color: var(--text-light)">${s.status}</span>`}}},{title:"Аккаунт Google",type:"text",value:s=>{var a;return((a=s.googleCredentials)==null?void 0:a.email)||""}},{title:"Дата создания",type:"date",value:s=>s.createdAt}];function n(s){return[{title:"Запустить сейчас",icon:"attention-yellow",action:()=>{i("trigger",s.id)}},{title:"Выключить",icon:"cross-red",if:s.status==="active",action:()=>{i("switch-on-off",s.id)}},{title:"Включить",icon:"check-green",if:s.status==="inactive",action:()=>{i("switch-on-off",s.id)}},{title:"Просмотреть ошибку",icon:"cross-red",if:s.status==="error",action:()=>{u(s)}},{title:"Удалить",icon:"delete",action:()=>{i("delete",s.id)}}]}function c(s){switch(s){case"poll_answer":return"poll";case"user":return"users";default:return null}}const l=U({isOpen:!1,bindingName:"",error:""});function u(s){s.lastErrorText&&(l.bindingName=s.name,l.error=s.lastErrorText,l.isOpen=!0)}return(s,a)=>{const _=de;return g(),y(Z,null,[m(_,{data:s.results,cols:o,actions:n,"is-loading":s.isLoading,class:"bindings-table"},null,8,["data","is-loading"]),m(_t,{"binding-name":l.bindingName,error:l.error,visible:l.isOpen,"onUpdate:visible":a[0]||(a[0]=r=>l.isOpen=r)},null,8,["binding-name","error","visible"])],64)}}});const gt=I(pt,[["__scopeId","data-v-8416465b"]]),vt=ue("google-docs-bindings:google-docs-bindings",()=>{const e=S.Services.GoogleSheetsBinding,t=S.Services.UI,i=_e(o,{immediate:!0});async function o(s){try{return await e.getBindings(s)}catch(a){t.openErrorModal("Ошибка при загрузке данных",a.message)}}async function n(s){try{await e.createBinding(s,{showLoader:!0}),t.openSuccessModal("Успешно сохранено"),i.trigger()}catch(a){t.openErrorModal("Ошибка при сохранении",a.message)}}async function c(s){try{await e.deleteBinding(s,{showLoader:!0}),t.openSuccessModal("Успешно удалено"),i.trigger()}catch(a){t.openErrorModal("Ошибка при удалении",a.message)}}async function l(s){try{await e.trigger(s,{showLoader:!0}),t.openSuccessModal("Интеграция запущена"),i.trigger()}catch(a){t.openErrorModal("Ошибка при запуске задания",a.message)}}async function u(s){try{await e.switchOnOff(s,{showLoader:!0}),t.openSuccessModal("Интеграция переключена"),i.trigger()}catch(a){t.openErrorModal("Ошибка при переключении",a.message)}}return{bindingsSearch:i,saveBinding:n,deleteBinding:c,triggerBinding:l,switchBindingOnOff:u}}),mt={class:"google-sheets-view"},yt={class:"google-sheets-view__integration-list"},ht={class:"google-sheets-view__integration-list__search"},ft={class:"google-sheets-view__integration-list__results"},bt={key:0,class:"google-sheets-view__integration-list__pagination"},wt=k({__name:"google-sheets-view",setup(e){const t=vt();return(i,o)=>{const n=pe,c=ge;return g(),y("div",mt,[m(A,null,{title:b(()=>[V(" Интеграции Google Sheets ")]),content:b(()=>[d("div",yt,[d("div",ht,[m(n,{modelValue:v(t).bindingsSearch.pagination.search,"onUpdate:modelValue":o[0]||(o[0]=l=>v(t).bindingsSearch.pagination.search=l),"is-loading":v(t).bindingsSearch.isListLoading},null,8,["modelValue","is-loading"])]),d("div",ft,[m(gt,{"is-loading":v(t).bindingsSearch.isListLoading,results:v(t).bindingsSearch.results,onDelete:o[1]||(o[1]=l=>v(t).deleteBinding(l)),onSwitchOnOff:o[2]||(o[2]=l=>v(t).switchBindingOnOff(l)),onTrigger:o[3]||(o[3]=l=>v(t).triggerBinding(l))},null,8,["is-loading","results"])]),v(t).bindingsSearch.resultsMeta.total>(v(t).bindingsSearch.pagination.limit||5)?(g(),y("div",bt,[m(c,{total:v(t).bindingsSearch.resultsMeta.total,page:v(t).bindingsSearch.pagination.page,"onUpdate:page":o[4]||(o[4]=l=>v(t).bindingsSearch.pagination.page=l),limit:v(t).bindingsSearch.pagination.limit},null,8,["total","page","limit"])])):L("",!0)])]),_:1}),m(A,null,{title:b(()=>[V(" Добавить интеграцию ")]),content:b(()=>[m(ut,{onCreateIntegration:o[5]||(o[5]=l=>v(t).saveBinding(l))})]),_:1})])}}});const It=I(wt,[["__scopeId","data-v-e1e06412"]]);export{It as default};
