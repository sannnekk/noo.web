import{d as R,C as h,O as T,P as U,r as M,L as C}from"./index-227761f5.js";const O=R("create-course-module:create-course",()=>{const c=h.Services.Course,y=h.Services.User,r=h.Services.UI,i=T(),m=U(),g=()=>({name:"",description:"",chapters:[],images:[]}),t=M(g()),d=M(""),f=M(!1);async function S(){if(!i.params.courseSlug){t.value=g();return}r.setLoading(!0);try{const e=await c.getCourse(i.params.courseSlug);if(!e.data){r.openErrorModal("Курс не найден");return}t.value=e.data}catch(e){t.value=g(),r.openErrorModal("Произошла ошибка при загрузке курса",e.message)}finally{r.setLoading(!1)}}function w(){if(!d.value.trim()){r.openWarningModal("У главы должно быть название");return}t.value.chapters.push({name:d.value,slug:C(),materials:[]}),d.value=""}function L(e,a){const s=p(e);s&&(s.name=a)}function p(e){var a;return(a=t.value.chapters)==null?void 0:a.find(s=>s.slug===e)}function x(e,a){var n;const s=p(e);if(s)return a==="new"?v():(n=s==null?void 0:s.materials)==null?void 0:n.find(o=>o.slug===a)}function v(e){return{name:e||"Новый материал",slug:C(),description:"",files:[],content:{ops:[{insert:`
`}]},order:0,workSolveDeadline:void 0,workCheckDeadline:void 0}}function E(e){var a;e||(e=p(i.params.chapterSlug)),e&&e.materials.push(v(`Новый материал ${((a=e.materials)==null?void 0:a.length)||0}`))}function I(e){var s,n;const a=(s=t.value.chapters)==null?void 0:s.findIndex(o=>o.slug===e);a!==void 0&&((n=t.value.chapters)==null||n.splice(a,1))}function W(e){var n,o,u;const a=(n=t.value.chapters)==null?void 0:n.findIndex(l=>l.slug===i.params.chapterSlug);if(a===void 0)return;const s=(o=t.value.chapters[a].materials)==null?void 0:o.findIndex(l=>l.slug===e);s!==void 0&&((u=t.value.chapters[a].materials)==null||u.splice(s,1))}async function b(){var e,a,s;if(!t.value.name.trim()){r.openWarningModal("У курса должно быть название");return}if(!((e=t.value.chapters)!=null&&e.length)){r.openWarningModal("Курс должен иметь хотя бы одну главу");return}for(const n of t.value.chapters){if(!n.name.trim()){r.openWarningModal("У главы должно быть название");return}if(!((a=n.materials)!=null&&a.length)){r.openWarningModal("Глава должна иметь хотя бы один материал");return}for(const o of n.materials){if(!o.name.trim()){r.openWarningModal("У материала должно быть название");return}if(!o.content.ops.length){r.openWarningModal("Материал не должен быть пустым");return}}}if(r.setLoading(!0),(s=t.value.chapters)==null||s.forEach((n,o)=>{var u;n.materials&&(n.order=o,n.materials=(u=n.materials)==null?void 0:u.map((l,N)=>({...l,order:N})))}),i.params.courseSlug)try{await c.updateCourse(t.value.id,t.value),r.openSuccessModal("Курс успешно обновлен","",[{label:"Вернуться к списку курсов",design:"primary",handler:()=>{m.push("/courses")}}])}catch(n){r.openErrorModal("Произошла ошибка при обновлении курса",n.message)}finally{r.setLoading(!1)}else try{await c.createCourse(t.value),r.openSuccessModal("Курс успешно создан","",[{label:"Вернуться к списку курсов",design:"primary",handler:()=>{m.push("/courses")}}])}catch(n){r.openErrorModal("Произошла ошибка при создании курса",n.message)}finally{r.setLoading(!1)}}async function k(){if(!f.value){f.value=!0;return}r.setLoading(!0);try{await c.deleteCourse(t.value.id),r.openSuccessModal("Курс успешно удален","",[{label:"Вернуться к списку курсов",design:"primary",handler:()=>{m.push("/courses")}}])}catch{r.openErrorModal("Произошла ошибка при удалении курса","Для удаления курса необходимо сначала убрать всех учеников")}finally{r.setLoading(!1),f.value=!1}}async function D(e){try{return await y.getTeachers(e)}catch{r.openErrorModal("Произошла ошибка при загрузке учителей")}}return{course:t,addChapter:w,changeChapterName:L,publishCourse:b,removeCourse:k,newChapterName:d,emptyMaterial:v,getChapter:p,getMaterial:x,removeChapter:I,removeMaterial:W,addMaterial:E,removeCourseModalVisible:f,fetchCourse:S,fetchTeachers:D}});export{O as u};
