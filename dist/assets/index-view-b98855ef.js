import{a as C,c as N,n as Q,o as d,b as m,q as R,F as E,B as P,h as $,m as k,d as B,C as x,O as U,r as b,L as M,g as l,f as v,w as g,e as s,t as w,s as O,v as j,x as z,I as G}from"./index-d17ade26.js";import{p as H}from"./poll-question-f586c578.js";const J={class:"poll-form"},K={class:"poll-form__questions"},W=C({__name:"poll-form",props:{questions:{},answers:{}},emits:["update:answers"],setup(c,{emit:r}){const f=c,n=N({get:()=>f.answers,set:o=>r("update:answers",o)});return(o,p)=>{const a=Q("auto-animate");return d(),m("div",J,[R((d(),m("div",K,[(d(!0),m(E,null,P(o.questions,(_,u)=>(d(),$(H,{key:_.id,question:_,index:u,answer:n.value[u],"onUpdate:answer":h=>n.value[u]=h},null,8,["question","index","answer","onUpdate:answer"]))),128))])),[[a]])])}}});const X=k(W,[["__scopeId","data-v-e7804a83"]]),Y=B("polls-module:poll",()=>{const c=x.Services.Poll,r=x.Services.UI,f=U(),n=b(),o=b([]);async function p(){r.setLoading(!0);try{const e=await c.getPoll(f.params.pollId);if(!(e!=null&&e.data))throw new Error("Опрос не найден или недоступен");n.value=e.data,a(n.value.questions)}catch(e){r.openErrorModal("Произошла ошибка при получении опроса",e.message,[{label:"Назад к блогу/новостям",design:"primary",handler:()=>window.location.replace("/blog")}])}finally{r.setLoading(!1)}}function a(e){o.value=e.map(t=>_(t))}function _(e){return{id:M(),questionId:e.id,questionType:e.type,date:new Date,text:"",choices:[],rating:0,files:[],number:0}}async function u(){if(n.value){r.setLoading(!0);try{h(n.value.questions,o.value);const e=o.value.map(t=>({...t,id:void 0}));await c.saveAnswers(n.value.id,e),r.openSuccessModal("Спасибо за участие в опросе!","Ваши ответы успешно сохранены",[{label:"Назад к блогу/новостям",design:"primary",handler:()=>window.location.replace("/blog")}])}catch(e){r.openErrorModal("Произошла ошибка при сохранении ответов",e.message,[{label:"Назад к блогу/новостям",design:"primary",handler:()=>window.location.replace("/blog")}])}finally{r.setLoading(!1)}}}function h(e,t){for(const i of e){const y=t.find(A=>A.questionId===i.id);if(i.required&&!y)throw new Error(`Ответ на вопрос "${i.text}" обязателен`);if(!T(i,y))throw new Error(`Ответ на вопрос "${i.text}" обязателен`)}}function T(e,t){switch(e.type){case"text":return V(e,t.text);case"choice":return F(e,t.choices);case"rating":return L(e,t.rating);case"number":return I(e,t.number);case"date":return D(e,t.date);case"file":return S(e,t.files);default:return!1}}function V(e,t){return!e.required&&!(t!=null&&t.length)?!0:!(e.maxLength&&e.maxLength<t.length||e.minLength&&e.minLength>t.length)}function I(e,t){return!e.required&&t===void 0?!0:!(t===void 0||e.maxValue&&e.maxValue<t||e.minValue&&e.minValue>t||e.onlyIntegerValue&&!Number.isInteger(t))}function F(e,t){return!e.required&&!(t!=null&&t.length)?!0:!(t===void 0||e.minChoices&&e.minChoices>t.length||e.maxChoices&&e.maxChoices<t.length)}function L(e,t){return!e.required&&t===void 0?!0:!(t===void 0||e.maxRating&&e.maxRating<t||e.minRating&&e.minRating>t||e.onlyIntegerRating&&!Number.isInteger(t))}function D(e,t){return!e.required&&!t?!0:!(!t||e.onlyFutureDate&&t<new Date||e.onlyPastDate&&t>new Date)}function S(e,t){if(!e.required&&!(t!=null&&t.length))return!0;if(!(t!=null&&t.length)||e.maxFileCount&&e.maxFileCount<t.length)return!1;for(const i of t)if(e.allowedFileTypes&&!e.allowedFileTypes.includes(i.mimeType))return!1;return!0}return{poll:n,fetchPoll:p,answers:o,saveAnswers:u}}),Z={key:0,class:"index-view"},q={class:"index-view__header"},ee={class:"index-view__description"},te={class:"index-view__actions"},re={class:"index-view__poll-form"},ne=C({__name:"index-view",setup(c){const r=Y();return r.fetchPoll(),(f,n)=>{const o=z,p=G;return l(r).poll?(d(),m("div",Z,[v(p,null,{sidebar:g(()=>[s("div",q,[s("h2",null,w(l(r).poll.title),1)]),s("div",ee,[s("p",null,w(l(r).poll.description),1)]),s("div",te,[v(o,{onClick:n[0]||(n[0]=a=>l(r).saveAnswers()),alignment:"stretch"},{default:g(()=>[O(" Сохранить ответы ")]),_:1})])]),content:g(()=>[s("div",re,[v(X,{questions:l(r).poll.questions,answers:l(r).answers,"onUpdate:answers":n[1]||(n[1]=a=>l(r).answers=a)},null,8,["questions","answers"])])]),_:1})])):j("",!0)}}});const le=k(ne,[["__scopeId","data-v-c57037db"]]);export{le as default};
