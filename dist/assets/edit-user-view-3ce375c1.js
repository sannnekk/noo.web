import{_ as q}from"./tabs-view-9c503450.js";import{_ as D}from"./statistics-view-37e9f081.js";import{_ as H}from"./calender-view-1794af74.js";import{a as V,Q as J,c as P,o as i,h as b,w as g,e as t,t as S,f as a,s as k,v as $,C as f,N as E,W as K,k as T,b as w,d as O,O as Q,r as M,u as R,g as o,ae as z,F as G,x as B,_ as X,i as Y,j as Z,p as F,l as N,m as L,K as ee,E as se,$ as te,c7 as oe,c8 as ne,J as ae,I as re,y as le}from"./index-d17ade26.js";import{_ as ie}from"./password-criteria-965b10a3.js";import{_ as ue}from"./select-input-c7f07e3e.js";import{_ as A}from"./entity-table-7112252a.js";import{_ as _e}from"./user-card-82c32199.js";import"./useDate-126c6fe0.js";import"./text-area-1a935c3b.js";const de={class:"input-group"},ce={class:"input-group"},me=t("br",null,null,-1),pe=V({__name:"change-password-modal",props:{user:{},visible:{type:Boolean}},emits:["confirm","update:visible"],setup(r,{emit:s}){const m=r,e=J({newPassword:"",repeatPassword:"",error:"",passwordIsStrong:!1}),p=P({get:()=>m.visible,set:v=>{v||(e.newPassword="",e.repeatPassword="",e.error=""),s("update:visible",v)}});function n(){if(f.Services.UI.setLoading(!0),e.newPassword!==e.repeatPassword){setTimeout(()=>{f.Services.UI.setLoading(!1),p.value=!0,e.error="Пароли не совпадают"},500);return}if(!e.passwordIsStrong){setTimeout(()=>{f.Services.UI.setLoading(!1),p.value=!0,e.error="Пароль не удовлетворяет требованиям"},500);return}s("confirm",e.newPassword),p.value=!1}return(v,_)=>{const d=E,h=ie,y=K,l=T;return i(),b(l,{onConfirm:n,visible:p.value,"onUpdate:visible":_[3]||(_[3]=u=>p.value=u)},{title:g(()=>[t("h3",null," Поменять пароль пользователю "+S(v.user.name)+" ("+S(v.user.username)+") ",1)]),text:g(()=>[t("div",de,[a(d,{type:"password",modelValue:e.newPassword,"onUpdate:modelValue":_[0]||(_[0]=u=>e.newPassword=u),label:"Новый пароль:"},null,8,["modelValue"])]),t("div",ce,[a(d,{type:"password",modelValue:e.repeatPassword,"onUpdate:modelValue":_[1]||(_[1]=u=>e.repeatPassword=u),label:"Повторите новый пароль:"},null,8,["modelValue"])]),a(h,{password:e.newPassword,modelValue:e.passwordIsStrong,"onUpdate:modelValue":_[2]||(_[2]=u=>e.passwordIsStrong=u)},null,8,["password","modelValue"]),me,e.error?(i(),b(y,{key:0},{default:g(()=>[k(S(e.error),1)]),_:1})):$("",!0)]),_:1},8,["visible"])}}}),ve={class:"teacher-form"},ge=t("h3",null,"Курсы преподавателя",-1),fe=V({__name:"teacher-form",props:{courses:{}},setup(r){const s=[{title:"#",type:"iterator"},{title:"Название",keys:["name"],type:"text"},{title:"Участники",keys:["students"],type:"text",value:m=>(m.students||[]).length}];return(m,e)=>{const p=A;return i(),w("div",ve,[ge,a(p,{cols:s,data:m.courses||[]},null,8,["data"])])}}}),he={class:"mentor-form"},we=t("h3",null,"Ученики куратора",-1),ye=V({__name:"mentor-form",props:{students:{}},setup(r){const s=[{title:"#",type:"iterator"},{title:"Имя",keys:["name"],type:"text"},{title:"Никнейм",keys:["username"],type:"text"},{title:"Email",keys:["email"],type:"text"}];return(m,e)=>{const p=A;return i(),w("div",he,[we,a(p,{cols:s,data:m.students||[]},null,8,["data"])])}}}),W=O("users-module:user",()=>{const r=f.Services.User;f.Services.Statistics;const s=f.Services.UI,m=Q(),e=M(null),p=R(n);async function n(l){try{return await r.getMentors(l)}catch(u){s.openErrorModal("Произошла ошибка при получении списка кураторов",u.message)}}async function v(){s.setLoading(!0);try{const l=await r.getUser(m.params.username);e.value=l.data}catch(l){s.openErrorModal("Произошла ошибка при получении данных пользователя",l.message)}finally{s.setLoading(!1)}}async function _(){if(e.value){s.setLoading(!0);try{await r.updateUser(e.value.id,e.value),s.openSuccessModal("Данные успешно сохранены")}catch(l){s.openErrorModal("Произошла ошибка при сохранении данных пользователя",l.message)}finally{s.setLoading(!1)}}}async function d(l){if(e.value){s.setLoading(!0);try{await r.assignMentor(e.value.id,l),s.openSuccessModal("Куратор успешно назначен")}catch(u){s.openErrorModal("Произошла ошибка при назначении куратора",u.message)}finally{s.setLoading(!1)}}}async function h(){if(e.value){s.setLoading(!0);try{await r.confirmUser(e.value.username),s.openSuccessModal("Пользователь подтвержден")}catch(l){s.openErrorModal("Произошла ошибка при подтверждении пользователя",l.message)}finally{s.setLoading(!1)}}}async function y(l){if(e.value){if(!["admin","teacher"].includes(f.Context.User.role)){s.openErrorModal("Недостаточно прав для изменения пароля");return}s.setLoading(!0);try{await r.updateUser(e.value.id,{id:e.value.id,password:l}),s.openSuccessModal("Пароль успешно изменен")}catch(u){s.openErrorModal("Произошла ошибка при изменении пароля",u.message)}finally{s.setLoading(!1)}}}return{mentorSearch:p,user:e,fetchUser:v,saveUser:_,assignMentor:d,confirmUser:h,changePassword:y}}),j=r=>(F("data-v-ccce7daf"),r=r(),N(),r),$e={class:"student-form"},be=j(()=>t("h3",null,"Куратор:",-1)),Ue={class:"row"},ke={class:"col-md-8 col-12"},Se={key:1},Ve={class:"col-md-4 col-12"},Me={class:"student-form__actions"},Ce=j(()=>t("h3",null,"Выберите куратора",-1)),xe={class:"change-mentor-modal__search"},Ie={class:"change-mentor-modal__list"},Le=V({__name:"student-form",props:{mentor:{}},emits:["assignMentor"],setup(r,{emit:s}){const m=r,e=W(),p=M(!1),n=M(m.mentor?[m.mentor.id]:[]);function v(){if(!n.value.length)return f.Services.UI.openWarningModal("Куратор не выбран");e.assignMentor(n.value[0])}return(_,d)=>{const h=_e,y=B,l=X,u=Y,U=Z,x=T;return i(),w(G,null,[t("div",$e,[be,t("div",Ue,[t("div",ke,[_.mentor?(i(),b(h,{key:0,user:_.mentor,link:`/users/edit/${_.mentor.username}`},null,8,["user","link"])):(i(),w("p",Se,"Пока нет куратора..."))]),t("div",Ve,[t("div",Me,[a(y,{design:"danger",alignment:"stretch",onClick:d[0]||(d[0]=c=>p.value=!0)},{default:g(()=>[k(S(_.mentor?"Поменять куратора":"Присвоить куратора"),1)]),_:1})])])])]),(i(),b(z,{to:"body"},[a(x,{class:"change-mentor-modal",visible:p.value,"onUpdate:visible":d[4]||(d[4]=c=>p.value=c),onConfirm:v},{title:g(()=>[Ce]),text:g(()=>[t("div",xe,[a(l,{modelValue:o(e).mentorSearch.pagination.search,"onUpdate:modelValue":d[1]||(d[1]=c=>o(e).mentorSearch.pagination.search=c),"is-loading":o(e).mentorSearch.isListLoading},null,8,["modelValue","is-loading"])]),t("div",Ie,[a(u,{items:o(e).mentorSearch.results,"item-label-key":"name","item-key":"id",modelValue:n.value,"onUpdate:modelValue":d[2]||(d[2]=c=>n.value=c)},null,8,["items","modelValue"]),a(U,{page:o(e).mentorSearch.pagination.page,"onUpdate:page":d[3]||(d[3]=c=>o(e).mentorSearch.pagination.page=c),total:o(e).mentorSearch.resultsMeta.total,limit:o(e).mentorSearch.pagination.limit},null,8,["page","total","limit"])])]),_:1},8,["visible"])]))],64)}}});const Pe=L(Le,[["__scopeId","data-v-ccce7daf"]]),Ee={class:"user-form"},Te={class:"row"},Be={class:"col-md-4"},Fe={class:"form-group role"},Ne={class:"col-md-4"},Ae={class:"form-group registration-date"},We={class:"col-md-4"},je={key:0,class:"form-group is-blocked"},qe={class:"row"},De={class:"col-12"},He={key:0,class:"fomr-group__course-list"},Je={key:1,class:"fomr-group__student-list"},Ke={key:2,class:"fomr-group__student-statistics"},Oe=V({__name:"user-form",props:{modelValue:{}},emits:["update:modelValue"],setup(r,{emit:s}){const m=r,e=P({get:()=>m.modelValue,set:n=>s("update:modelValue",n)}),p=[{label:"Ученик",value:"student"},{label:"Куратор",value:"mentor"},{label:"Преподаватель",value:"teacher"},{label:"Администратор",value:"admin"}];return(n,v)=>{var y,l,u;const _=ue,d=E,h=ee;return i(),w("div",Ee,[t("div",Te,[t("div",Be,[t("div",Fe,[a(_,{modelValue:e.value.role,"onUpdate:modelValue":v[0]||(v[0]=U=>e.value.role=U),label:"Роль",options:p,readonly:e.value.role!=="student"||((y=o(f).Context.User)==null?void 0:y.role)==="mentor"},null,8,["modelValue","readonly"])])]),t("div",Ne,[t("div",Ae,[a(d,{modelValue:e.value.createdAt,"onUpdate:modelValue":v[1]||(v[1]=U=>e.value.createdAt=U),label:"Дата регистрации",type:"datetime-local",readonly:""},null,8,["modelValue"])])]),t("div",We,[["admin","teacher"].includes((l=o(f).Context.User)==null?void 0:l.role)?(i(),w("div",je,[a(h,{readonly:e.value.id===((u=o(f).Context.User)==null?void 0:u.id),modelValue:e.value.isBlocked,"onUpdate:modelValue":v[2]||(v[2]=U=>e.value.isBlocked=U),label:"Заблокирован"},null,8,["readonly","modelValue"])])):$("",!0)])]),t("div",qe,[t("div",De,[e.value.role==="teacher"?(i(),w("div",He,[a(fe,{courses:e.value.courses},null,8,["courses"])])):e.value.role==="mentor"?(i(),w("div",Je,[a(ye,{students:e.value.students},null,8,["students"])])):e.value.role==="student"?(i(),w("div",Ke,[a(Pe,{mentor:e.value.mentor},null,8,["mentor"])])):$("",!0)])])])}}});const Qe=L(Oe,[["__scopeId","data-v-4f0cdc81"]]),Re=r=>(F("data-v-910eff94"),r=r(),N(),r),ze={class:"edit-user-view"},Ge={class:"edit-user-view__credentials"},Xe={class:"edit-user-view__credentials__avatar"},Ye={class:"edit-user-view__credentials__name"},Ze={class:"edit-user-view__credentials__username"},es={class:"edit-user-view__credentials__email"},ss={class:"edit-user-view__credentials__role"},ts={key:0,class:"edit-user-view__credentials__telegram"},os={key:1,class:"edit-user-view__credentials__change-password"},ns={class:"edit-user-view__content"},as={class:"edit-user-view__content__unverified-block"},rs=Re(()=>t("p",null,[t("b",null,"Пользователь не подтвержден"),t("br"),k(" Пользователь не сможет войти в систему, пока не подтвердит свой аккаунт через имейл ")],-1)),ls={class:"edit-user-view__content__form"},is={class:"edit-user-view__content__actions"},us={class:"edit-user-view__content__actions__return"},_s={class:"edit-user-view__content__actions__save"},ds={class:"edit-user-view__calender"},cs={class:"edit-user-view__statistics"},ms=V({__name:"edit-user-view",setup(r){const s=W();s.fetchUser();const m=M(!1);se(()=>s.user,()=>{s.user&&(le(s.user.name),document.querySelector(".pane-layout__header .header__page-title h1").innerHTML=s.user.name)},{immediate:!0,deep:!0});const e=M(0);return(p,n)=>{const v=te,_=oe,d=ne,h=B,y=ae,l=re,u=H,U=D,x=q;return i(),b(x,{titles:["Данные","Календарь","Статистика"],onTabChange:n[6]||(n[6]=c=>e.value=c)},{"tab-0":g(()=>[t("div",ze,[o(s).user?(i(),b(l,{key:0},{sidebar:g(()=>{var c,I;return[t("div",Ge,[t("div",Xe,[a(v,{src:o(s).user.avatar,name:o(s).user.name},null,8,["src","name"])]),t("div",Ye,[t("h2",null,S(o(s).user.name),1)]),t("div",Ze,[t("p",null,[k(" Никнейм: "),t("b",null,S(o(s).user.username),1)])]),t("div",es,[t("p",null,[k(" Email: "),t("b",null,S(o(s).user.email),1)])]),t("div",ss,[a(_,{role:o(s).user.role},null,8,["role"])]),o(s).user.telegramUsername?(i(),w("div",ts,[a(d,{username:o(s).user.telegramUsername},null,8,["username"])])):$("",!0),((c=o(f).Context.User)==null?void 0:c.role)==="admin"||((I=o(f).Context.User)==null?void 0:I.role)==="teacher"?(i(),w("div",os,[a(h,{design:"danger",alignment:"center",onClick:n[0]||(n[0]=C=>m.value=!0)},{default:g(()=>[k(" Сменить пароль ")]),_:1}),a(pe,{visible:m.value,"onUpdate:visible":n[1]||(n[1]=C=>m.value=C),user:o(s).user,onConfirm:n[2]||(n[2]=C=>o(s).changePassword(C))},null,8,["visible","user"])])):$("",!0)])]}),content:g(()=>[t("div",ns,[o(s).user.verificationToken?(i(),b(y,{key:0},{default:g(()=>{var c;return[t("div",as,[rs,["admin","teacher"].includes(((c=o(f).Context.User)==null?void 0:c.role)||"$$anonymous$$")?(i(),b(h,{key:0,design:"warning",alignment:"right",onClick:n[3]||(n[3]=I=>o(s).confirmUser())},{default:g(()=>[k(" Подтвердить ")]),_:1})):$("",!0)])]}),_:1})):$("",!0),t("div",ls,[a(Qe,{modelValue:o(s).user,"onUpdate:modelValue":n[4]||(n[4]=c=>o(s).user=c)},null,8,["modelValue"])]),t("div",is,[t("div",us,[a(h,{to:"/users",alignment:"right",design:"secondary"},{default:g(()=>[k(" Назад ")]),_:1})]),t("div",_s,[a(h,{onClick:n[5]||(n[5]=c=>o(s).saveUser()),alignment:"right",design:"primary"},{default:g(()=>[k(" Сохранить ")]),_:1})])])])]),_:1})):$("",!0)])]),"tab-1":g(()=>[t("div",ds,[o(s).user&&e.value===1?(i(),b(u,{key:0,username:o(s).user.username},null,8,["username"])):$("",!0)])]),"tab-2":g(()=>[t("div",cs,[o(s).user&&e.value===2?(i(),b(U,{key:0,username:o(s).user.username},null,8,["username"])):$("",!0)])]),_:1})}}});const ks=L(ms,[["__scopeId","data-v-910eff94"]]);export{ks as default};
